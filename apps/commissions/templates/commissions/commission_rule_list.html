{% extends "base/base_dashboard.html" %}

{% block content %}
<!-- Commission Rules Manager Component -->
<div class="container-fluid">
    <div class="card border-0 shadow-sm" style="border-radius: 16px;">
        <div class="card-header border-0 d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem 2rem;">
            <h5 class="card-title mb-0 fw-semibold">
                <i class="ti ti-gavel me-2"></i>Gerenciar Regras de Comissão
            </h5>
            <button type="button" class="btn btn-light btn-sm px-3 py-2" data-bs-toggle="modal" data-bs-target="#createRuleModal" style="border-radius: 8px; font-weight: 500;">
                <i class="ti ti-plus me-1"></i>Nova Regra
            </button>
        </div>
        <div class="card-body" style="padding: 2rem;">
            <!-- Rules List -->
            <div class="table-responsive">
                <!-- removed table-hover class for cleaner look -->
                <table class="table table-borderless">
                    <thead>
                        <tr style="border-bottom: 2px solid #e5e7eb;">
                            <th class="border-0 fw-medium text-muted py-3" style="font-size: 0.875rem; letter-spacing: 0.025em;">Nome da Regra</th>
                            <th class="border-0 fw-medium text-muted py-3" style="font-size: 0.875rem; letter-spacing: 0.025em;">Tipo</th>
                            <th class="border-0 fw-medium text-muted py-3" style="font-size: 0.875rem; letter-spacing: 0.025em;">Descrição</th>
                            <th class="border-0 fw-medium text-muted py-3" style="font-size: 0.875rem; letter-spacing: 0.025em;">Criado Por</th>
                            <th class="border-0 fw-medium text-muted py-3" style="font-size: 0.875rem; letter-spacing: 0.025em;">Data Criação</th>
                            <th class="border-0 fw-medium text-muted py-3" style="font-size: 0.875rem; letter-spacing: 0.025em;">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="rulesTableBody">
                        {% for rule in commission_rules %}
                        <tr style="border-bottom: 1px solid #f3f4f6;">
                            <td class="py-4">
                                <div class="fw-medium" style="color: #374151;">{{ rule.name }}</div>
                            </td>
                            <td class="py-4">
                                <span class="badge px-3 py-2" style="
                                    background-color: {% if rule.rule_type == 'FLAT' %}#dbeafe{% elif rule.rule_type == 'TIERED' %}#d1fae5{% else %}#fef3c7{% endif %}; 
                                    color: {% if rule.rule_type == 'FLAT' %}#1e40af{% elif rule.rule_type == 'TIERED' %}#065f46{% else %}#92400e{% endif %}; 
                                    border: 1px solid {% if rule.rule_type == 'FLAT' %}#bfdbfe{% elif rule.rule_type == 'TIERED' %}#a7f3d0{% else %}#fde68a{% endif %};
                                    border-radius: 6px;
                                    font-weight: 500;
                                    font-size: 0.75rem;
                                ">
                                    {{ rule.get_rule_type_display }}
                                </span>
                            </td>
                            <td class="py-4">
                                <span style="color: #6b7280; font-size: 0.875rem;">{{ rule.description|truncatechars:50 }}</span>
                            </td>
                            <td class="py-4" style="color: #6b7280; font-size: 0.875rem;">{{ rule.created_by.username|default:"Sistema" }}</td>
                            <td class="py-4" style="color: #6b7280; font-size: 0.875rem;">{{ rule.created_at|date:"d/m/Y H:i" }}</td>
                            <td class="py-4">
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-sm" onclick="viewRule({{ rule.id }})" title="Visualizar" style="background-color: #f0f9ff; color: #0891b2; border: 1px solid #e0f2fe; border-radius: 6px; padding: 0.375rem 0.75rem;">
                                        <i class="ti ti-eye"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm" onclick="editRule({{ rule.id }})" title="Editar" style="background-color: #fffbeb; color: #d97706; border: 1px solid #fef3c7; border-radius: 6px; padding: 0.375rem 0.75rem;">
                                        <i class="ti ti-edit"></i>
                                    </button>
                                    {% if rule.rule_type == 'TIERED' %}
                                    <button type="button" class="btn btn-sm" onclick="manageTiers({{ rule.id }})" title="Gerenciar Faixas" style="background-color: #f0fdf4; color: #16a34a; border: 1px solid #dcfce7; border-radius: 6px; padding: 0.375rem 0.75rem;">
                                        <i class="ti ti-layers-intersect"></i>
                                    </button>
                                    {% endif %}
                                    <button type="button" class="btn btn-sm" onclick="deleteRule({{ rule.id }})" title="Excluir" style="background-color: #fef2f2; color: #dc2626; border: 1px solid #fecaca; border-radius: 6px; padding: 0.375rem 0.75rem;">
                                        <i class="ti ti-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center py-5">
                                <div class="empty-state">
                                    <i class="ti ti-inbox display-4 mb-3" style="color: #d1d5db;"></i>
                                    <h6 style="color: #6b7280; font-weight: 500;">Nenhuma regra de comissão cadastrada</h6>
                                    <p style="color: #9ca3af; font-size: 0.875rem;">Clique em "Nova Regra" para começar</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Rule Modal -->
<!-- Enhanced modal design with better styling and spacing -->
<div class="modal fade" id="createRuleModal" tabindex="-1" aria-labelledby="createRuleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0" style="border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);">
            <div class="modal-header border-0" style="background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem 2rem;">
                <h5 class="modal-title fw-semibold" id="createRuleModalLabel">
                    <i class="ti ti-plus me-2"></i>Nova Regra de Comissão
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="ruleForm" method="post">
                {% csrf_token %}
                <div class="modal-body" style="padding: 2rem;">
                    <div class="row g-4">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="ruleName" class="form-label fw-medium mb-2" style="color: #374151;">Nome da Regra <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="ruleName" name="name" required maxlength="100" placeholder="Ex: Comissão Padrão 5%" style="border: 1px solid #d1d5db; border-radius: 8px; padding: 0.75rem 1rem; font-size: 0.875rem;">
                                <div class="form-text" style="color: #6b7280; font-size: 0.75rem; margin-top: 0.5rem;">
                                    <i class="ti ti-info-circle me-1"></i>
                                    Escolha um nome descritivo para identificar facilmente esta regra
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="ruleType" class="form-label fw-medium mb-2" style="color: #374151;">Tipo de Regra <span class="text-danger">*</span></label>
                                <select class="form-select" id="ruleType" name="rule_type" required onchange="toggleRuleTypeFields()" style="border: 1px solid #d1d5db; border-radius: 8px; padding: 0.75rem 1rem; font-size: 0.875rem;">
                                    <option value="">Selecione...</option>
                                    <option value="FLAT">Valor Fixo</option>
                                    <option value="TIERED">Por Faixa</option>
                                    <option value="BONUS">Bônus</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label for="ruleDescription" class="form-label fw-medium mb-2" style="color: #374151;">Descrição</label>
                        <textarea class="form-control" id="ruleDescription" name="description" rows="3" placeholder="Descreva como esta regra funciona e quando deve ser aplicada..." style="border: 1px solid #d1d5db; border-radius: 8px; padding: 0.75rem 1rem; font-size: 0.875rem;"></textarea>
                    </div>

                    <!-- Flat Rate Configuration -->
                    <div id="flatRateConfig" class="rule-config d-none">
                        <div class="alert border-0 mb-4" style="background-color: #f0f9ff; border-radius: 12px; padding: 1rem;">
                            <div class="d-flex align-items-center">
                                <i class="ti ti-info-circle fs-5 me-3" style="color: #0891b2;"></i>
                                <div>
                                    <h6 class="mb-1 fw-medium" style="color: #0891b2;">Valor Fixo</h6>
                                    <p class="mb-0" style="color: #0e7490; font-size: 0.875rem;">Uma porcentagem fixa será aplicada sobre todas as vendas.</p>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="flatPercentage" class="form-label fw-medium mb-2" style="color: #374151;">Percentual de Comissão (%)</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="flatPercentage" name="flat_percentage" min="0" max="100" step="0.01" placeholder="5.00" style="border: 1px solid #d1d5db; border-radius: 8px 0 0 8px; padding: 0.75rem 1rem; font-size: 0.875rem;">
                                    <span class="input-group-text" style="background-color: #0891b2; color: white; border: 1px solid #0891b2; border-radius: 0 8px 8px 0;">%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tiered Configuration -->
                    <div id="tieredConfig" class="rule-config d-none">
                        <div class="alert border-0 mb-4" style="background-color: #f0fdf4; border-radius: 12px; padding: 1rem;">
                            <div class="d-flex align-items-center">
                                <i class="ti ti-layers-intersect fs-5 me-3" style="color: #16a34a;"></i>
                                <div>
                                    <h6 class="mb-1 fw-medium" style="color: #16a34a;">Por Faixa</h6>
                                    <p class="mb-0" style="color: #15803d; font-size: 0.875rem;">Diferentes percentuais para diferentes faixas de vendas. Configure as faixas após criar a regra.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Bonus Configuration -->
                    <div id="bonusConfig" class="rule-config d-none">
                        <div class="alert border-0 mb-4" style="background-color: #fffbeb; border-radius: 12px; padding: 1rem;">
                            <div class="d-flex align-items-center">
                                <i class="ti ti-gift fs-5 me-3" style="color: #d97706;"></i>
                                <div>
                                    <h6 class="mb-1 fw-medium" style="color: #d97706;">Bônus</h6>
                                    <p class="mb-0" style="color: #b45309; font-size: 0.875rem;">Valor adicional baseado em metas ou critérios específicos.</p>
                                </div>
                            </div>
                        </div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="bonusAmount" class="form-label fw-medium mb-2" style="color: #374151;">Valor do Bônus (R$)</label>
                                <div class="input-group">
                                    <span class="input-group-text" style="background-color: #d97706; color: white; border: 1px solid #d97706; border-radius: 8px 0 0 8px;">R$</span>
                                    <input type="number" class="form-control" id="bonusAmount" name="bonus_amount" min="0" step="0.01" placeholder="500.00" style="border: 1px solid #d1d5db; border-radius: 0 8px 8px 0; padding: 0.75rem 1rem; font-size: 0.875rem;">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="bonusThreshold" class="form-label fw-medium mb-2" style="color: #374151;">Meta Mínima (R$)</label>
                                <div class="input-group">
                                    <span class="input-group-text" style="background-color: #d97706; color: white; border: 1px solid #d97706; border-radius: 8px 0 0 8px;">R$</span>
                                    <input type="number" class="form-control" id="bonusThreshold" name="bonus_threshold" min="0" step="0.01" placeholder="10000.00" style="border: 1px solid #d1d5db; border-radius: 0 8px 8px 0; padding: 0.75rem 1rem; font-size: 0.875rem;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0" style="background-color: #f9fafb; border-radius: 0 0 16px 16px; padding: 1.5rem 2rem;">
                    <button type="button" class="btn px-4 py-2" data-bs-dismiss="modal" style="background-color: #f3f4f6; color: #374151; border: 1px solid #d1d5db; border-radius: 8px; font-weight: 500;">
                        <i class="ti ti-x me-1"></i>Cancelar
                    </button>
                    <button type="submit" class="btn px-4 py-2" style="background-color: #0891b2; color: white; border: 1px solid #0891b2; border-radius: 8px; font-weight: 500;">
                        <i class="ti ti-device-floppy me-1"></i>Salvar Regra
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Manage Tiers Modal -->
<!-- Enhanced tiers modal with better layout and styling -->
<div class="modal fade" id="manageTiersModal" tabindex="-1" aria-labelledby="manageTiersModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content border-0" style="border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);">
            <div class="modal-header border-0" style="background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem 2rem;">
                <h5 class="modal-title fw-semibold" id="manageTiersModalLabel">
                    <i class="ti ti-layers-intersect me-2"></i>Gerenciar Faixas de Comissão
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="padding: 2rem;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h6 class="mb-1 fw-medium">Faixas para: <span id="tierRuleName" style="color: #0891b2;"></span></h6>
                        <p class="mb-0" style="color: #6b7280; font-size: 0.875rem;">Configure os percentuais para cada faixa de vendas</p>
                    </div>
                    <button type="button" class="btn px-3 py-2" onclick="addTier()" style="background-color: #16a34a; color: white; border: 1px solid #16a34a; border-radius: 8px; font-weight: 500;">
                        <i class="ti ti-plus me-1"></i>Adicionar Faixa
                    </button>
                </div>
                
                <div class="alert border-0 mb-4" style="background-color: #f0f9ff; border-radius: 12px; padding: 1rem;">
                    <div class="d-flex align-items-start">
                        <i class="ti ti-info-circle fs-5 me-3 mt-1" style="color: #0891b2;"></i>
                        <div>
                            <h6 class="mb-1 fw-medium" style="color: #0891b2;">Como funciona</h6>
                            <p class="mb-0" style="color: #0e7490; font-size: 0.875rem;">As faixas são aplicadas em ordem crescente. Exemplo: 0-1000 (5%), 1001-5000 (7%), 5001+ (10%)</p>
                        </div>
                    </div>
                </div>

                <div id="tiersContainer" class="tiers-container">
                    <!-- Tiers will be loaded here -->
                </div>
            </div>
            <div class="modal-footer border-0" style="background-color: #f9fafb; border-radius: 0 0 16px 16px; padding: 1.5rem 2rem;">
                <button type="button" class="btn px-4 py-2" data-bs-dismiss="modal" style="background-color: #f3f4f6; color: #374151; border: 1px solid #d1d5db; border-radius: 8px; font-weight: 500;">
                    <i class="ti ti-x me-1"></i>Fechar
                </button>
                <button type="button" class="btn px-4 py-2" onclick="saveTiers()" style="background-color: #16a34a; color: white; border: 1px solid #16a34a; border-radius: 8px; font-weight: 500;">
                    <i class="ti ti-device-floppy me-1"></i>Salvar Faixas
                </button>
            </div>
        </div>
    </div>
</div>

<!-- View Rule Details Modal -->
<!-- Enhanced details modal with better information layout -->
<div class="modal fade" id="viewRuleModal" tabindex="-1" aria-labelledby="viewRuleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0" style="border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);">
            <div class="modal-header border-0" style="background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem 2rem;">
                <h5 class="modal-title fw-semibold" id="viewRuleModalLabel">
                    <i class="ti ti-eye me-2"></i>Detalhes da Regra
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="padding: 2rem;" id="ruleDetailsContent">
                <!-- Rule details will be loaded here -->
            </div>
            <div class="modal-footer border-0" style="background-color: #f9fafb; border-radius: 0 0 16px 16px; padding: 1.5rem 2rem;">
                <button type="button" class="btn px-4 py-2" data-bs-dismiss="modal" style="background-color: #f3f4f6; color: #374151; border: 1px solid #d1d5db; border-radius: 8px; font-weight: 500;">
                    <i class="ti ti-x me-1"></i>Fechar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables
let currentRuleId = null;
let tiersData = [];

// Toggle rule type specific fields
function toggleRuleTypeFields() {
    const ruleType = document.getElementById('ruleType').value;
    const configs = document.querySelectorAll('.rule-config');
    
    configs.forEach(config => config.classList.add('d-none'));
    
    if (ruleType === 'FLAT') {
        document.getElementById('flatRateConfig').classList.remove('d-none');
    } else if (ruleType === 'TIERED') {
        document.getElementById('tieredConfig').classList.remove('d-none');
    } else if (ruleType === 'BONUS') {
        document.getElementById('bonusConfig').classList.remove('d-none');
    }
}

// View rule details
function viewRule(ruleId) {
    fetch(`/api/v1/commissions/rules/${ruleId}/`)
        .then(response => response.json())
        .then(data => {
            let content = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Informações Básicas</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Nome:</strong></td><td>${data.name}</td></tr>
                            <tr><td><strong>Tipo:</strong></td><td><span class="badge bg-primary">${data.rule_type_display}</span></td></tr>
                            <tr><td><strong>Criado por:</strong></td><td>${data.created_by || 'Sistema'}</td></tr>
                            <tr><td><strong>Data:</strong></td><td>${data.created_at}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Descrição</h6>
                        <p class="text-muted">${data.description || 'Sem descrição'}</p>
                    </div>
                </div>
            `;
            
            if (data.rule_type === 'TIERED' && data.tiers && data.tiers.length > 0) {
                content += `
                    <hr>
                    <h6>Faixas de Comissão</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead><tr><th>Até (R$)</th><th>Percentual (%)</th></tr></thead>
                            <tbody>
                `;
                data.tiers.forEach(tier => {
                    content += `<tr><td>R$ ${tier.limit_value}</td><td>${tier.percentage}%</td></tr>`;
                });
                content += `</tbody></table></div>`;
            }
            
            document.getElementById('ruleDetailsContent').innerHTML = content;
            new bootstrap.Modal(document.getElementById('viewRuleModal')).show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erro ao carregar detalhes da regra');
        });
}

// Edit rule
function editRule(ruleId) {
    fetch(`/api/v1/commissions/rules/${ruleId}/`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('createRuleModalLabel').innerHTML = '<i class="ti ti-edit me-2"></i>Editar Regra de Comissão';
            document.getElementById('ruleName').value = data.name;
            document.getElementById('ruleType').value = data.rule_type;
            document.getElementById('ruleDescription').value = data.description || '';
            
            currentRuleId = ruleId;
            toggleRuleTypeFields();
            
            new bootstrap.Modal(document.getElementById('createRuleModal')).show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erro ao carregar dados da regra');
        });
}

// Delete rule
function deleteRule(ruleId) {
    if (confirm('Tem certeza que deseja excluir esta regra? Esta ação não pode ser desfeita.')) {
        fetch(`/api/v1/commissions/rules/${ruleId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('Erro ao excluir regra');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erro ao excluir regra');
        });
    }
}

// Manage tiers
function manageTiers(ruleId) {
    currentRuleId = ruleId;
    
    fetch(`/api/v1/commissions/rules/${ruleId}/tiers/`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('tierRuleName').textContent = data.rule_name;
            tiersData = data.tiers || [];
            renderTiers();
            new bootstrap.Modal(document.getElementById('manageTiersModal')).show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erro ao carregar faixas');
        });
}

// Render tiers
function renderTiers() {
    const container = document.getElementById('tiersContainer');
    
    if (tiersData.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="ti ti-inbox fs-1 d-block mb-2"></i>
                Nenhuma faixa configurada
            </div>
        `;
        return;
    }
    
    let html = '';
    tiersData.forEach((tier, index) => {
        html += `
            <div class="card mb-2">
                <div class="card-body py-2">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <label class="form-label mb-1">Valor Limite (R$)</label>
                            <input type="number" class="form-control form-control-sm" 
                                   value="${tier.limit_value}" 
                                   onchange="updateTier(${index}, 'limit_value', this.value)"
                                   min="0" step="0.01">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label mb-1">Percentual (%)</label>
                            <input type="number" class="form-control form-control-sm" 
                                   value="${tier.percentage}" 
                                   onchange="updateTier(${index}, 'percentage', this.value)"
                                   min="0" max="100" step="0.01">
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeTier(${index})">
                                <i class="ti ti-trash"></i> Remover
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Add new tier
function addTier() {
    tiersData.push({
        limit_value: 0,
        percentage: 0,
        id: null
    });
    renderTiers();
}

// Update tier
function updateTier(index, field, value) {
    tiersData[index][field] = parseFloat(value) || 0;
}

// Remove tier
function removeTier(index) {
    tiersData.splice(index, 1);
    renderTiers();
}

// Save tiers
function saveTiers() {
    fetch(`/api/v1/commissions/rules/${currentRuleId}/tiers/save/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ tiers: tiersData })
    })
    .then(response => {
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('manageTiersModal')).hide();
            alert('Faixas salvas com sucesso!');
        } else {
            alert('Erro ao salvar faixas');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Erro ao salvar faixas');
    });
}

// Reset modal when closed
document.getElementById('createRuleModal').addEventListener('hidden.bs.modal', function () {
    document.getElementById('ruleForm').reset();
    document.getElementById('createRuleModalLabel').innerHTML = '<i class="ti ti-plus me-2"></i>Nova Regra de Comissão';
    document.querySelectorAll('.rule-config').forEach(config => config.classList.add('d-none'));
    currentRuleId = null;
});

// Form submission
document.getElementById('ruleForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const url = currentRuleId 
        ? `/api/v1/commissions/rules/${currentRuleId}/`
        : `/api/v1/commissions/rules/`;
    const method = currentRuleId ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
    })
    .then(response => {
        if (response.ok) {
            location.reload();
        } else {
            alert('Erro ao salvar regra');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Erro ao salvar regra');
    });
});
</script>

<style>
/* Enhanced styling for better visual appeal */
.rule-config {
    background-color: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 1.5rem;
    margin-top: 1.5rem;
}

.table th {
    border-top: none;
    font-weight: 500;
    color: #6b7280;
    font-size: 0.875rem;
    letter-spacing: 0.025em;
}

.table td {
    vertical-align: middle;
}

.form-control, .form-select {
    transition: all 0.2s ease;
}

.form-control:focus, .form-select:focus {
    border-color: #0891b2;
    box-shadow: 0 0 0 3px rgba(8, 145, 178, 0.1);
}

.btn {
    transition: all 0.2s ease;
    font-weight: 500;
}

.btn:hover {
    transform: translateY(-1px);
}

.empty-state {
    padding: 3rem 1rem;
}

.tiers-container .card {
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    transition: all 0.2s ease;
    margin-bottom: 1rem;
}

.tiers-container .card:hover {
    border-color: #0891b2;
    box-shadow: 0 4px 12px rgba(8, 145, 178, 0.1);
}

.alert {
    border-radius: 12px;
}

.badge {
    font-weight: 500;
}

.card {
    transition: all 0.2s ease;
}

.modal-content {
    backdrop-filter: blur(10px);
}

.input-group-text {
    font-weight: 500;
}
</style>
{% endblock %}
