{% extends "base/base_dashboard.html" %}

{% block content %}
<!-- Commission Rules Manager Component -->
<div class="container-fluid">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="ti ti-gavel me-2"></i>Gerenciar Regras de Comissão
            </h5>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createRuleModal">
                <i class="ti ti-plus me-1"></i>Nova Regra
            </button>
        </div>
        <div class="card-body">
            <!-- Rules List -->
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Nome da Regra</th>
                            <th>Tipo</th>
                            <th>Descrição</th>
                            <th>Criado Por</th>
                            <th>Data Criação</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="rulesTableBody">
                        <!-- Dynamic content will be loaded here -->
                        {% for rule in commission_rules %}
                        <tr>
                            <td>
                                <strong>{{ rule.name }}</strong>
                            </td>
                            <td>
                                <span class="badge bg-{% if rule.rule_type == 'FLAT' %}primary{% elif rule.rule_type == 'TIERED' %}success{% else %}warning{% endif %}">
                                    {{ rule.get_rule_type_display }}
                                </span>
                            </td>
                            <td>
                                <small class="text-muted">{{ rule.description|truncatechars:50 }}</small>
                            </td>
                            <td>{{ rule.created_by.username|default:"Sistema" }}</td>
                            <td>{{ rule.created_at|date:"d/m/Y H:i" }}</td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-info" onclick="viewRule({{ rule.id }})" title="Visualizar">
                                        <i class="ti ti-eye"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-warning" onclick="editRule({{ rule.id }})" title="Editar">
                                        <i class="ti ti-edit"></i>
                                    </button>
                                    {% if rule.rule_type == 'TIERED' %}
                                    <button type="button" class="btn btn-outline-success" onclick="manageTiers({{ rule.id }})" title="Gerenciar Faixas">
                                        <i class="ti ti-layers-intersect"></i>
                                    </button>
                                    {% endif %}
                                    <button type="button" class="btn btn-outline-danger" onclick="deleteRule({{ rule.id }})" title="Excluir">
                                        <i class="ti ti-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center text-muted py-4">
                                <i class="ti ti-inbox fs-1 d-block mb-2"></i>
                                Nenhuma regra de comissão cadastrada
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Rule Modal -->
<div class="modal fade" id="createRuleModal" tabindex="-1" aria-labelledby="createRuleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createRuleModalLabel">
                    <i class="ti ti-plus me-2"></i>Nova Regra de Comissão
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="ruleForm" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="ruleName" class="form-label">Nome da Regra <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="ruleName" name="name" required maxlength="100">
                                <div class="form-text">Ex: Comissão Padrão 5%, Bônus Fim de Ano</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="ruleType" class="form-label">Tipo de Regra <span class="text-danger">*</span></label>
                                <select class="form-select" id="ruleType" name="rule_type" required onchange="toggleRuleTypeFields()">
                                    <option value="">Selecione...</option>
                                    <option value="FLAT">Valor Fixo</option>
                                    <option value="TIERED">Por Faixa</option>
                                    <option value="BONUS">Bônus</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="ruleDescription" class="form-label">Descrição</label>
                        <textarea class="form-control" id="ruleDescription" name="description" rows="3" placeholder="Descreva como esta regra funciona..."></textarea>
                    </div>

                    <!-- Flat Rate Configuration -->
                    <div id="flatRateConfig" class="rule-config d-none">
                        <div class="alert alert-info">
                            <i class="ti ti-info-circle me-2"></i>
                            <strong>Valor Fixo:</strong> Uma porcentagem fixa será aplicada sobre todas as vendas.
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="flatPercentage" class="form-label">Percentual de Comissão (%)</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="flatPercentage" name="flat_percentage" min="0" max="100" step="0.01">
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tiered Configuration -->
                    <div id="tieredConfig" class="rule-config d-none">
                        <div class="alert alert-warning">
                            <i class="ti ti-layers-intersect me-2"></i>
                            <strong>Por Faixa:</strong> Diferentes percentuais para diferentes faixas de vendas. Configure as faixas após criar a regra.
                        </div>
                    </div>

                    <!-- Bonus Configuration -->
                    <div id="bonusConfig" class="rule-config d-none">
                        <div class="alert alert-success">
                            <i class="ti ti-gift me-2"></i>
                            <strong>Bônus:</strong> Valor adicional baseado em metas ou critérios específicos.
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="bonusAmount" class="form-label">Valor do Bônus (R$)</label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input type="number" class="form-control" id="bonusAmount" name="bonus_amount" min="0" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="bonusThreshold" class="form-label">Meta Mínima (R$)</label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input type="number" class="form-control" id="bonusThreshold" name="bonus_threshold" min="0" step="0.01">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="ti ti-device-floppy me-1"></i>Salvar Regra
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Manage Tiers Modal -->
<div class="modal fade" id="manageTiersModal" tabindex="-1" aria-labelledby="manageTiersModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="manageTiersModalLabel">
                    <i class="ti ti-layers-intersect me-2"></i>Gerenciar Faixas de Comissão
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">Faixas para: <span id="tierRuleName" class="text-primary"></span></h6>
                    <button type="button" class="btn btn-sm btn-success" onclick="addTier()">
                        <i class="ti ti-plus me-1"></i>Adicionar Faixa
                    </button>
                </div>
                
                <div class="alert alert-info">
                    <i class="ti ti-info-circle me-2"></i>
                    <strong>Como funciona:</strong> As faixas são aplicadas em ordem crescente. Ex: 0-1000 (5%), 1001-5000 (7%), 5001+ (10%)
                </div>

                <div id="tiersContainer">
                    <!-- Tiers will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" onclick="saveTiers()">
                    <i class="ti ti-device-floppy me-1"></i>Salvar Faixas
                </button>
            </div>
        </div>
    </div>
</div>

<!-- View Rule Details Modal -->
<div class="modal fade" id="viewRuleModal" tabindex="-1" aria-labelledby="viewRuleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewRuleModalLabel">
                    <i class="ti ti-eye me-2"></i>Detalhes da Regra
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="ruleDetailsContent">
                <!-- Rule details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables
let currentRuleId = null;
let tiersData = [];

// Toggle rule type specific fields
function toggleRuleTypeFields() {
    const ruleType = document.getElementById('ruleType').value;
    const configs = document.querySelectorAll('.rule-config');
    
    configs.forEach(config => config.classList.add('d-none'));
    
    if (ruleType === 'FLAT') {
        document.getElementById('flatRateConfig').classList.remove('d-none');
    } else if (ruleType === 'TIERED') {
        document.getElementById('tieredConfig').classList.remove('d-none');
    } else if (ruleType === 'BONUS') {
        document.getElementById('bonusConfig').classList.remove('d-none');
    }
}

// View rule details
function viewRule(ruleId) {
    fetch(`/api/v1/commissions/rules/${ruleId}/`)
        .then(response => response.json())
        .then(data => {
            let content = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Informações Básicas</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Nome:</strong></td><td>${data.name}</td></tr>
                            <tr><td><strong>Tipo:</strong></td><td><span class="badge bg-primary">${data.rule_type_display}</span></td></tr>
                            <tr><td><strong>Criado por:</strong></td><td>${data.created_by || 'Sistema'}</td></tr>
                            <tr><td><strong>Data:</strong></td><td>${data.created_at}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Descrição</h6>
                        <p class="text-muted">${data.description || 'Sem descrição'}</p>
                    </div>
                </div>
            `;
            
            if (data.rule_type === 'TIERED' && data.tiers && data.tiers.length > 0) {
                content += `
                    <hr>
                    <h6>Faixas de Comissão</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead><tr><th>Até (R$)</th><th>Percentual (%)</th></tr></thead>
                            <tbody>
                `;
                data.tiers.forEach(tier => {
                    content += `<tr><td>R$ ${tier.limit_value}</td><td>${tier.percentage}%</td></tr>`;
                });
                content += `</tbody></table></div>`;
            }
            
            document.getElementById('ruleDetailsContent').innerHTML = content;
            new bootstrap.Modal(document.getElementById('viewRuleModal')).show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erro ao carregar detalhes da regra');
        });
}

// Edit rule
function editRule(ruleId) {
    fetch(`/api/v1/commissions/rules/${ruleId}/`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('createRuleModalLabel').innerHTML = '<i class="ti ti-edit me-2"></i>Editar Regra de Comissão';
            document.getElementById('ruleName').value = data.name;
            document.getElementById('ruleType').value = data.rule_type;
            document.getElementById('ruleDescription').value = data.description || '';
            
            currentRuleId = ruleId;
            toggleRuleTypeFields();
            
            new bootstrap.Modal(document.getElementById('createRuleModal')).show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erro ao carregar dados da regra');
        });
}

// Delete rule
function deleteRule(ruleId) {
    if (confirm('Tem certeza que deseja excluir esta regra? Esta ação não pode ser desfeita.')) {
        fetch(`/api/v1/commissions/rules/${ruleId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('Erro ao excluir regra');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erro ao excluir regra');
        });
    }
}

// Manage tiers
function manageTiers(ruleId) {
    currentRuleId = ruleId;
    
    fetch(`/api/v1/commissions/rules/${ruleId}/tiers/`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('tierRuleName').textContent = data.rule_name;
            tiersData = data.tiers || [];
            renderTiers();
            new bootstrap.Modal(document.getElementById('manageTiersModal')).show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erro ao carregar faixas');
        });
}

// Render tiers
function renderTiers() {
    const container = document.getElementById('tiersContainer');
    
    if (tiersData.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="ti ti-inbox fs-1 d-block mb-2"></i>
                Nenhuma faixa configurada
            </div>
        `;
        return;
    }
    
    let html = '';
    tiersData.forEach((tier, index) => {
        html += `
            <div class="card mb-2">
                <div class="card-body py-2">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <label class="form-label mb-1">Valor Limite (R$)</label>
                            <input type="number" class="form-control form-control-sm" 
                                   value="${tier.limit_value}" 
                                   onchange="updateTier(${index}, 'limit_value', this.value)"
                                   min="0" step="0.01">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label mb-1">Percentual (%)</label>
                            <input type="number" class="form-control form-control-sm" 
                                   value="${tier.percentage}" 
                                   onchange="updateTier(${index}, 'percentage', this.value)"
                                   min="0" max="100" step="0.01">
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeTier(${index})">
                                <i class="ti ti-trash"></i> Remover
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Add new tier
function addTier() {
    tiersData.push({
        limit_value: 0,
        percentage: 0,
        id: null
    });
    renderTiers();
}

// Update tier
function updateTier(index, field, value) {
    tiersData[index][field] = parseFloat(value) || 0;
}

// Remove tier
function removeTier(index) {
    tiersData.splice(index, 1);
    renderTiers();
}

// Save tiers
function saveTiers() {
    fetch(`/api/v1/commissions/rules/${currentRuleId}/tiers/save/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ tiers: tiersData })
    })
    .then(response => {
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('manageTiersModal')).hide();
            alert('Faixas salvas com sucesso!');
        } else {
            alert('Erro ao salvar faixas');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Erro ao salvar faixas');
    });
}

// Reset modal when closed
document.getElementById('createRuleModal').addEventListener('hidden.bs.modal', function () {
    document.getElementById('ruleForm').reset();
    document.getElementById('createRuleModalLabel').innerHTML = '<i class="ti ti-plus me-2"></i>Nova Regra de Comissão';
    document.querySelectorAll('.rule-config').forEach(config => config.classList.add('d-none'));
    currentRuleId = null;
});

// Form submission
document.getElementById('ruleForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const url = currentRuleId 
        ? `/api/v1/commissions/rules/${currentRuleId}/`
        : `/api/v1/commissions/rules/`;
    const method = currentRuleId ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
    })
    .then(response => {
        if (response.ok) {
            location.reload();
        } else {
            alert('Erro ao salvar regra');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Erro ao salvar regra');
    });
});
</script>


<style>
.rule-config {
    border: 1px solid #e9ecef;
    border-radius: 0.375rem;
    padding: 1rem;
    margin-top: 1rem;
}

.table th {
    border-top: none;
    font-weight: 600;
    color: #495057;
}

.btn-group-sm > .btn {
    padding: 0.25rem 0.5rem;
}

.modal-xl {
    max-width: 1140px;
}

.tier-item {
    background: #f8f9fa;
    border-radius: 0.375rem;
    padding: 1rem;
    margin-bottom: 0.5rem;
}
</style>
{% endblock %}

